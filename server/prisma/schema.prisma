// server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int            @id @default(autoincrement())
  username     String         @unique
  email        String         @unique
  passwordHash String
  xpTotal      Int            @default(0)
  createdAt    DateTime       @default(now())
  roadmaps     Roadmap[] // Relation: User created these roadmaps
  progress     UserProgress[] // Relation: User's progress on nodes
}

model Roadmap {
  id          Int      @id @default(autoincrement())
  title       String
  description String?  @db.Text
  createdAt   DateTime @default(now())

  userId Int?
  user   User? @relation(fields: [userId], references: [id])

  nodes Node[]
  edges Edge[]
}

model Node {
  id        String  @id // We use String IDs (like "1", "2") because graph libs often use strings
  roadmapId Int
  roadmap   Roadmap @relation(fields: [roadmapId], references: [id], onDelete: Cascade)

  title       String
  description String? @db.Text
  xpReward    Int     @default(100)
  positionX   Float   @default(0)
  positionY   Float   @default(0)
  content     String? @db.Text // Markdown content

  // Relations for the Graph structure
  outgoingEdges Edge[] @relation("SourceNode")
  incomingEdges Edge[] @relation("TargetNode")

  // User progress on this specific node
  userProgress UserProgress[]
}

model Edge {
  id        Int     @id @default(autoincrement())
  roadmapId Int
  roadmap   Roadmap @relation(fields: [roadmapId], references: [id], onDelete: Cascade)

  sourceNodeId String
  targetNodeId String

  sourceNode Node @relation("SourceNode", fields: [sourceNodeId], references: [id], onDelete: Cascade)
  targetNode Node @relation("TargetNode", fields: [targetNodeId], references: [id], onDelete: Cascade)
}

model UserProgress {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  nodeId String
  node   Node   @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  status      String    @default("LOCKED") // LOCKED, AVAILABLE, COMPLETED
  completedAt DateTime?

  @@unique([userId, nodeId]) // A user has only one progress entry per node
}
